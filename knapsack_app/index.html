<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Knapsack App (Frontend + Backend)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; line-height: 1.35; }
    details { margin: 12px 0 20px; border: 1px solid #ddd; border-radius: 8px; padding: 10px 14px; }
    summary { font-weight: 600; cursor: pointer; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    input, select, button { padding: 6px 8px; font-size: 14px; }
    table { border-collapse: collapse; width: 100%; margin: 10px 0; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; text-align: left; }
    th { background: #f8f8f8; }
    .results { background: #fbfbfb; border: 1px solid #eee; padding: 10px; border-radius: 6px; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #eef3ff; color: #1a49a2; font-size: 12px; }
    .muted { color: #666; font-size: 12px; }
  </style>
</head>
<body>
  <h1>Knapsack App</h1>
  <p class="muted">Runs with a Python backend (Flask). Start the server and use this UI.</p>

  <details open>
    <summary>Resource Allocation (0/1) – Projects within Budget</summary>
    <div class="row">
      <label>Budget: <input id="proj-budget" type="number" min="0" step="1" value="15" /></label>
      <button id="proj-add">Add Project</button>
      <button id="proj-solve">Solve via API</button>
      <span class="pill">0/1</span>
    </div>
    <table id="proj-table">
      <thead>
        <tr><th>Name</th><th>Cost</th><th>Benefit</th><th>Action</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="proj-results" class="results"></div>
  </details>

  <details>
    <summary>Portfolio Optimization – Capital Budget</summary>
    <div class="row">
      <label>Capital: <input id="port-capital" type="number" min="0" step="0.01" value="120" /></label>
      <label>Mode: 
        <select id="port-mode">
          <option value="fractional">Fractional</option>
          <option value="01">0/1</option>
        </select>
      </label>
      <button id="port-add">Add Asset</button>
      <button id="port-solve">Solve via API</button>
      <span class="pill">Fractional / 0/1</span>
    </div>
    <table id="port-table">
      <thead>
        <tr><th>Name</th><th>Price</th><th>Expected Return</th><th>Action</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="port-results" class="results"></div>
  </details>

  <details>
    <summary>Scheduling (0/1) – Time-Limited Tasks</summary>
    <div class="row">
      <label>Time Limit: <input id="sched-limit" type="number" min="0" step="1" value="10" /></label>
      <button id="sched-add">Add Task</button>
      <button id="sched-solve">Solve via API</button>
      <span class="pill">0/1</span>
    </div>
    <table id="sched-table">
      <thead>
        <tr><th>Name</th><th>Duration</th><th>Reward</th><th>Action</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="sched-results" class="results"></div>
  </details>

  <script>
    function addRow(tbody, cols) {
      const tr = document.createElement('tr');
      for (const { placeholder, type = 'text', step = 'any', value = '' } of cols) {
        const td = document.createElement('td');
        const input = document.createElement('input');
        input.type = type; input.placeholder = placeholder; input.step = step; input.value = value;
        td.appendChild(input); tr.appendChild(td);
      }
      const tdAct = document.createElement('td');
      const btn = document.createElement('button');
      btn.textContent = 'Remove';
      btn.onclick = () => tr.remove();
      tdAct.appendChild(btn); tr.appendChild(tdAct);
      tbody.appendChild(tr);
    }

    function readTableNumeric(tbody, nameIdx, weightIdx, valueIdx) {
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const names = [], weights = [], values = [];
      for (const r of rows) {
        const cells = r.querySelectorAll('td > input');
        const name = cells[nameIdx].value.trim() || `Item ${names.length + 1}`;
        const w = Number(cells[weightIdx].value);
        const v = Number(cells[valueIdx].value);
        if (!Number.isFinite(w) || !Number.isFinite(v)) continue;
        names.push(name); weights.push(w); values.push(v);
      }
      return { names, weights, values };
    }

    // ----- Projects -----
    const projBody = document.querySelector('#proj-table tbody');
    const projAdd = document.getElementById('proj-add');
    const projSolve = document.getElementById('proj-solve');
    const projBudget = document.getElementById('proj-budget');
    const projResults = document.getElementById('proj-results');

    function seedProjects() {
      const samples = [
        { n: 'CRM Upgrade', c: 7, b: 16 },
        { n: 'Mobile App', c: 5, b: 10 },
        { n: 'Data Lake', c: 8, b: 12 },
        { n: 'Security Audit', c: 3, b: 6 },
        { n: 'A/B Testing', c: 4, b: 7 },
      ];
      for (const s of samples) addRow(projBody, [
        { placeholder: 'Name', value: s.n },
        { placeholder: 'Cost', type: 'number', step: '1', value: String(s.c) },
        { placeholder: 'Benefit', type: 'number', step: '0.01', value: String(s.b) },
      ]);
    }

    projAdd.onclick = () => addRow(projBody, [
      { placeholder: 'Name' },
      { placeholder: 'Cost', type: 'number', step: '1' },
      { placeholder: 'Benefit', type: 'number', step: '0.01' },
    ]);

    projSolve.onclick = async () => {
      const budget = Math.max(0, Math.floor(Number(projBudget.value) || 0));
      const rows = Array.from(projBody.querySelectorAll('tr')).map(r => {
        const cells = r.querySelectorAll('td > input');
        return { name: cells[0].value || 'Item', cost: Number(cells[1].value), benefit: Number(cells[2].value) };
      }).filter(x => Number.isFinite(x.cost) && Number.isFinite(x.benefit));
      const res = await fetch('/api/projects', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ budget, projects: rows }) });
      const data = await res.json();
      projResults.innerHTML = '' +
        `<div><strong>Max Benefit:</strong> ${data.max_benefit.toFixed(2)}</div>` +
        `<div><strong>Used Budget:</strong> ${data.used_budget} / ${budget}</div>` +
        '<div><strong>Chosen Projects:</strong></div>' +
        '<ul>' + data.chosen_projects.map(p => `<li>${p[0]} — cost ${p[1]}, benefit ${p[2]}</li>`).join('') + '</ul>';
    };

    seedProjects();

    // ----- Portfolio -----
    const portBody = document.querySelector('#port-table tbody');
    const portAdd = document.getElementById('port-add');
    const portSolve = document.getElementById('port-solve');
    const portCapital = document.getElementById('port-capital');
    const portMode = document.getElementById('port-mode');
    const portResults = document.getElementById('port-results');

    function seedAssets() {
      const samples = [
        { n: 'ETF_A', p: 50.0, r: 5.5 },
        { n: 'ETF_B', p: 40.0, r: 4.0 },
        { n: 'Bond_Fund', p: 30.0, r: 2.7 },
        { n: 'Growth_Fund', p: 70.0, r: 7.5 },
      ];
      for (const s of samples) addRow(portBody, [
        { placeholder: 'Name', value: s.n },
        { placeholder: 'Price', type: 'number', step: '0.01', value: String(s.p) },
        { placeholder: 'Expected Return', type: 'number', step: '0.01', value: String(s.r) },
      ]);
    }

    portAdd.onclick = () => addRow(portBody, [
      { placeholder: 'Name' },
      { placeholder: 'Price', type: 'number', step: '0.01' },
      { placeholder: 'Expected Return', type: 'number', step: '0.01' },
    ]);

    portSolve.onclick = async () => {
      const capital = Math.max(0, Number(portCapital.value) || 0);
      const rows = Array.from(portBody.querySelectorAll('tr')).map(r => {
        const cells = r.querySelectorAll('td > input');
        return { name: cells[0].value || 'Item', price: Number(cells[1].value), expected_return: Number(cells[2].value) };
      }).filter(x => Number.isFinite(x.price) && Number.isFinite(x.expected_return));
      const allow_fractional = portMode.value === 'fractional';
      const res = await fetch('/api/portfolio', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ capital, assets: rows, allow_fractional }) });
      const data = await res.json();
      if (allow_fractional) {
        const positions = data.positions.map(p => `<li>${p[0]} — ${p[1].toFixed(2)} units, capital ${p[2].toFixed(2)}, contribution ${p[3].toFixed(2)}</li>`).join('');
        portResults.innerHTML = '' +
          `<div><strong>Total Expected Return:</strong> ${data.total_expected_return.toFixed(2)}</div>` +
          `<div><strong>Capital Used:</strong> ${data.capital_used.toFixed(2)} / ${capital.toFixed(2)}</div>` +
          '<div><strong>Positions:</strong></div>' +
          `<ul>${positions}</ul>`;
      } else {
        const positions = data.positions.map(p => `<li>${p[0]} — 1 unit, price ${p[2].toFixed(2)}, return ${p[3].toFixed(2)}</li>`).join('');
        portResults.innerHTML = '' +
          `<div><strong>Total Expected Return:</strong> ${data.total_expected_return.toFixed(2)}</div>` +
          `<div><strong>Capital Used:</strong> ${data.capital_used.toFixed(2)} / ${capital.toFixed(2)}</div>` +
          '<div><strong>Positions:</strong></div>' +
          `<ul>${positions}</ul>`;
      }
    };

    seedAssets();

    // ----- Scheduling -----
    const schedBody = document.querySelector('#sched-table tbody');
    const schedAdd = document.getElementById('sched-add');
    const schedSolve = document.getElementById('sched-solve');
    const schedLimit = document.getElementById('sched-limit');
    const schedResults = document.getElementById('sched-results');

    function seedTasks() {
      const samples = [
        { n: 'Write Report', d: 4, r: 6.0 },
        { n: 'Implement Feature', d: 7, r: 15.0 },
        { n: 'Fix Bugs', d: 3, r: 9.0 },
        { n: 'Team Training', d: 6, r: 10.0 },
        { n: 'Client Meeting', d: 2, r: 4.0 },
      ];
      for (const s of samples) addRow(schedBody, [
        { placeholder: 'Name', value: s.n },
        { placeholder: 'Duration', type: 'number', step: '1', value: String(s.d) },
        { placeholder: 'Reward', type: 'number', step: '0.01', value: String(s.r) },
      ]);
    }

    schedAdd.onclick = () => addRow(schedBody, [
      { placeholder: 'Name' },
      { placeholder: 'Duration', type: 'number', step: '1' },
      { placeholder: 'Reward', type: 'number', step: '0.01' },
    ]);

    schedSolve.onclick = async () => {
      const time_limit = Math.max(0, Math.floor(Number(schedLimit.value) || 0));
      const rows = Array.from(schedBody.querySelectorAll('tr')).map(r => {
        const cells = r.querySelectorAll('td > input');
        return { name: cells[0].value || 'Item', duration: Number(cells[1].value), reward: Number(cells[2].value) };
      }).filter(x => Number.isFinite(x.duration) && Number.isFinite(x.reward));
      const res = await fetch('/api/scheduling', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ time_limit, tasks: rows }) });
      const data = await res.json();
      const chosen = data.chosen_tasks.map(t => `<li>${t[0]} — duration ${t[1]}, reward ${t[2]}</li>`).join('');
      schedResults.innerHTML = '' +
        `<div><strong>Max Reward:</strong> ${data.max_reward.toFixed(2)}</div>` +
        `<div><strong>Time Used:</strong> ${data.time_used} / ${time_limit}</div>` +
        '<div><strong>Chosen Tasks:</strong></div>' +
        `<ul>${chosen}</ul>`;
    };

    seedTasks();
  </script>
</body>
</html>
